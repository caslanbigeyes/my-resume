{
  "title": "GitHub Webhook å®ç°æœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²",
  "excerpt": "è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ GitHub Webhook å®ç°ä»£ç æ¨é€åçš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨é…ç½®ã€è„šæœ¬ç¼–å†™å’Œ PM2 è¿›ç¨‹ç®¡ç†ã€‚",
  "publishedAt": "2024-02-01T00:00:00.000Z",
  "author": "hero",
  "category": "devops",
  "tags": [
    "webhook",
    "deployment",
    "github",
    "pm2",
    "automation"
  ],
  "featured": true,
  "published": true,
  "image": "/images/articles/webhook-deploy.jpg",
  "seoTitle": "GitHub Webhook è‡ªåŠ¨åŒ–éƒ¨ç½²å®Œå…¨æŒ‡å— - ä»é…ç½®åˆ°å®è·µ",
  "seoDescription": "å­¦ä¹ å¦‚ä½•é…ç½® GitHub Webhook å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨è®¾ç½®ã€å®‰å…¨é…ç½®å’Œæ•…éšœæ’é™¤",
  "seoKeywords": [
    "GitHub Webhook",
    "è‡ªåŠ¨åŒ–éƒ¨ç½²",
    "CI/CD",
    "æœåŠ¡å™¨éƒ¨ç½²",
    "PM2"
  ],
  "body": {
    "raw": "\n# GitHub Webhook å®ç°æœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²\n\n## æ¦‚è¿°\n\nè‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯ç°ä»£è½¯ä»¶å¼€å‘ä¸­çš„é‡è¦ç¯èŠ‚ï¼Œé€šè¿‡ GitHub Webhook å¯ä»¥å®ç°ä»£ç æ¨é€åçš„è‡ªåŠ¨éƒ¨ç½²ï¼Œå¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä»é›¶å¼€å§‹é…ç½®ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿã€‚\n\n## éƒ¨ç½²æ¶æ„\n\n```\nGitHub Repository â†’ Webhook â†’ æœåŠ¡å™¨æ¥æ”¶ â†’ æ‰§è¡Œéƒ¨ç½²è„šæœ¬ â†’ é‡å¯åº”ç”¨\n```\n\n## ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨å‡†å¤‡\n\n### 1. è´­ä¹°å’Œé…ç½®æœåŠ¡å™¨\n\n#### æœåŠ¡å™¨é€‰æ‹©\n- **æ¨èé…ç½®**: 2æ ¸4Gå†…å­˜ï¼Œ40Gç¡¬ç›˜ï¼ˆé€‚åˆä¸­å°å‹é¡¹ç›®ï¼‰\n- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS æˆ– CentOS 7+\n- **äº‘æœåŠ¡å•†**: é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€AWSã€DigitalOcean ç­‰\n\n#### åŸºç¡€ç¯å¢ƒå®‰è£…\n```bash\n# æ›´æ–°ç³»ç»Ÿ\nsudo apt update && sudo apt upgrade -y\n\n# å®‰è£… Node.js (ä½¿ç”¨ NodeSource ä»“åº“)\ncurl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -\nsudo apt-get install -y nodejs\n\n# å®‰è£… Git\nsudo apt install git -y\n\n# å®‰è£… PM2 (è¿›ç¨‹ç®¡ç†å™¨)\nsudo npm install -g pm2\n\n# å®‰è£… Nginx (å¯é€‰ï¼Œç”¨äºåå‘ä»£ç†)\nsudo apt install nginx -y\n```\n\n### 2. åŸŸåé…ç½®\n\n#### DNS è§£æè®¾ç½®\n```bash\n# A è®°å½•é…ç½®ç¤ºä¾‹\nType: A\nName: @\nValue: ä½ çš„æœåŠ¡å™¨IPåœ°å€\nTTL: 600\n\n# å­åŸŸåé…ç½® (å¯é€‰)\nType: A\nName: api\nValue: ä½ çš„æœåŠ¡å™¨IPåœ°å€\nTTL: 600\n```\n\n#### SSL è¯ä¹¦é…ç½® (æ¨èä½¿ç”¨ Let's Encrypt)\n```bash\n# å®‰è£… Certbot\nsudo apt install certbot python3-certbot-nginx -y\n\n# è·å– SSL è¯ä¹¦\nsudo certbot --nginx -d yourdomain.com -d www.yourdomain.com\n```\n\n### 3. å®‰å…¨ç»„é…ç½®\n\n#### å¼€æ”¾å¿…è¦ç«¯å£\n```bash\n# å¼€æ”¾ SSH (22)\nsudo ufw allow 22\n\n# å¼€æ”¾ HTTP (80) å’Œ HTTPS (443)\nsudo ufw allow 80\nsudo ufw allow 443\n\n# å¼€æ”¾ Webhook ç«¯å£ (3001)\nsudo ufw allow 3001\n\n# å¼€æ”¾åº”ç”¨ç«¯å£ (3000)\nsudo ufw allow 3000\n\n# å¯ç”¨é˜²ç«å¢™\nsudo ufw enable\n```\n\n#### äº‘æœåŠ¡å•†å®‰å…¨ç»„è®¾ç½®\nåœ¨äº‘æœåŠ¡å•†æ§åˆ¶å°ä¸­é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š\n- å…¥æ–¹å‘ï¼šå¼€æ”¾ 22, 80, 443, 3000, 3001 ç«¯å£\n- å‡ºæ–¹å‘ï¼šå…è®¸æ‰€æœ‰æµé‡\n\n## ç¬¬äºŒæ­¥ï¼šGitHub Webhook é…ç½®\n\n### 1. åˆ›å»ºéƒ¨ç½²è„šæœ¬\n\n#### åˆ›å»ºè„šæœ¬ç›®å½•\n```bash\n# åˆ›å»º hooks ç›®å½•\nsudo mkdir -p /var/www/hooks\nsudo chown $USER:$USER /var/www/hooks\n\n# åˆ›å»ºé¡¹ç›®ç›®å½•\nsudo mkdir -p /var/www/my-resume\nsudo chown $USER:$USER /var/www/my-resume\n```\n\n#### éƒ¨ç½²è„šæœ¬ (`/var/www/hooks/github-webhook.sh`)\n```bash\n#!/bin/bash\n\n# è®¾ç½®é”™è¯¯æ—¶é€€å‡º\nset -e\n\n# æ—¥å¿—æ–‡ä»¶\nLOG_FILE=\"/var/www/hooks/deploy.log\"\nPROJECT_DIR=\"/var/www/my-resume\"\n\n# è®°å½•æ—¥å¿—å‡½æ•°\nlog() {\n    echo \"$(date '+%Y-%m-%d %H:%M:%S') - $1\" | tee -a \"$LOG_FILE\"\n}\n\nlog \"=== å¼€å§‹éƒ¨ç½² ===\"\n\n# æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨\nif [ ! -d \"$PROJECT_DIR\" ]; then\n    log \"é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨å…‹éš†ä»“åº“...\"\n    git clone https://github.com/your-username/my-resume.git \"$PROJECT_DIR\"\n    cd \"$PROJECT_DIR\"\nelse\n    cd \"$PROJECT_DIR\" || { log \"è¿›å…¥é¡¹ç›®ç›®å½•å¤±è´¥\"; exit 1; }\nfi\n\nlog \"æ‹‰å–æœ€æ–°ä»£ç ...\"\ngit fetch || { log \"git fetch å¤±è´¥\"; exit 1; }\ngit reset --hard origin/main || { log \"git reset å¤±è´¥\"; exit 1; }\ngit pull origin main || { log \"git pull å¤±è´¥\"; exit 1; }\n\nlog \"å®‰è£…ä¾èµ–...\"\nnpm install --legacy-peer-deps || { log \"npm install å¤±è´¥\"; exit 1; }\n\nlog \"æ„å»ºé¡¹ç›®...\"\nnpm run build || { log \"npm run build å¤±è´¥\"; exit 1; }\n\nlog \"é‡å¯ PM2 æœåŠ¡...\"\npm2 restart my-resume || {\n    log \"PM2 é‡å¯å¤±è´¥ï¼Œå°è¯•å¯åŠ¨æ–°å®ä¾‹...\"\n    pm2 start npm --name my-resume -- run start\n}\n\nlog \"æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶...\"\nfind \"$PROJECT_DIR\" -name \"node_modules\" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true\n\nlog \"=== éƒ¨ç½²å®Œæˆ ===\"\n```\n\n#### è®¾ç½®è„šæœ¬æƒé™\n```bash\nchmod +x /var/www/hooks/github-webhook.sh\n```\n### 2. Webhook æœåŠ¡å™¨\n\n#### åˆ›å»º Webhook æœåŠ¡ (`/var/www/hooks/webhook.js`)\n```javascript\nconst express = require('express');\nconst crypto = require('crypto');\nconst { exec } = require('child_process');\nconst fs = require('fs');\nconst path = require('path');\n\nconst app = express();\nconst PORT = process.env.PORT || 3001;\nconst SECRET = process.env.WEBHOOK_SECRET || 'your-webhook-secret';\nconst LOG_FILE = '/var/www/hooks/webhook.log';\n\n// ä¸­é—´ä»¶\napp.use(express.json({ limit: '1mb' }));\napp.use(express.urlencoded({ extended: true }));\n\n// æ—¥å¿—å‡½æ•°\nconst log = (message) => {\n    const timestamp = new Date().toISOString();\n    const logMessage = `${timestamp} - ${message}\\n`;\n    console.log(logMessage.trim());\n    fs.appendFileSync(LOG_FILE, logMessage);\n};\n\n// éªŒè¯ GitHub Webhook ç­¾å\nconst verifySignature = (payload, signature) => {\n    if (!signature) return false;\n\n    const hmac = crypto.createHmac('sha256', SECRET);\n    const digest = 'sha256=' + hmac.update(payload).digest('hex');\n\n    return crypto.timingSafeEqual(\n        Buffer.from(signature),\n        Buffer.from(digest)\n    );\n};\n\n// Webhook ç«¯ç‚¹\napp.post('/webhook', (req, res) => {\n    const signature = req.headers['x-hub-signature-256'];\n    const payload = JSON.stringify(req.body);\n\n    // éªŒè¯ç­¾åï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰\n    if (SECRET && !verifySignature(payload, signature)) {\n        log('âŒ ç­¾åéªŒè¯å¤±è´¥');\n        return res.status(401).send('Unauthorized');\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æ˜¯ push äº‹ä»¶åˆ° main åˆ†æ”¯\n    if (req.body.ref !== 'refs/heads/main') {\n        log(`â„¹ï¸ å¿½ç•¥é main åˆ†æ”¯çš„æ¨é€: ${req.body.ref}`);\n        return res.status(200).send('Ignored: Not main branch');\n    }\n\n    log('ğŸš€ æ”¶åˆ° GitHub Webhookï¼Œå¼€å§‹éƒ¨ç½²...');\n\n    // æ‰§è¡Œéƒ¨ç½²è„šæœ¬\n    const deployScript = '/var/www/hooks/github-webhook.sh';\n    const child = exec(`bash ${deployScript}`, {\n        cwd: '/var/www/hooks',\n        timeout: 300000 // 5åˆ†é’Ÿè¶…æ—¶\n    });\n\n    let output = '';\n\n    child.stdout.on('data', (data) => {\n        output += data;\n        log(`ğŸ“ ${data.trim()}`);\n    });\n\n    child.stderr.on('data', (data) => {\n        output += data;\n        log(`âš ï¸ ${data.trim()}`);\n    });\n\n    child.on('close', (code) => {\n        if (code === 0) {\n            log('âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ');\n            res.status(200).send('Deployment successful');\n        } else {\n            log(`âŒ éƒ¨ç½²å¤±è´¥ï¼Œé€€å‡ºç : ${code}`);\n            res.status(500).send('Deployment failed');\n        }\n    });\n\n    child.on('error', (error) => {\n        log(`âŒ æ‰§è¡Œè„šæœ¬æ—¶å‡ºé”™: ${error.message}`);\n        res.status(500).send('Script execution error');\n    });\n});\n\n// å¥åº·æ£€æŸ¥ç«¯ç‚¹\napp.get('/health', (req, res) => {\n    res.status(200).json({\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n        uptime: process.uptime()\n    });\n});\n\n// æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰\napp.get('/logs', (req, res) => {\n    try {\n        const logs = fs.readFileSync(LOG_FILE, 'utf8');\n        res.type('text/plain').send(logs);\n    } catch (error) {\n        res.status(404).send('Log file not found');\n    }\n});\n\n// é”™è¯¯å¤„ç†ä¸­é—´ä»¶\napp.use((error, req, res, next) => {\n    log(`âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}`);\n    res.status(500).send('Internal Server Error');\n});\n\n// å¯åŠ¨æœåŠ¡å™¨\napp.listen(PORT, '0.0.0.0', () => {\n    log(`ğŸŒ Webhook æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);\n});\n\n// ä¼˜é›…å…³é—­\nprocess.on('SIGTERM', () => {\n    log('ğŸ“´ æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n    process.exit(0);\n});\n\nprocess.on('SIGINT', () => {\n    log('ğŸ“´ æ”¶åˆ° SIGINT ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n    process.exit(0);\n});\n```\n\n#### å®‰è£…ä¾èµ–\n```bash\ncd /var/www/hooks\nnpm init -y\nnpm install express\n```\n\n\n### 3. GitHub ä»“åº“é…ç½®\n\n#### åœ¨ GitHub ä¸­è®¾ç½® Webhook\n1. è¿›å…¥ä½ çš„ GitHub ä»“åº“\n2. ç‚¹å‡» `Settings` â†’ `Webhooks` â†’ `Add webhook`\n3. é…ç½® Webhookï¼š\n   ```\n   Payload URL: http://your-domain.com:3001/webhook\n   Content type: application/json\n   Secret: your-webhook-secret (ä¸æœåŠ¡å™¨ä¸­çš„ SECRET ä¸€è‡´)\n   Events: Just the push event\n   Active: âœ“\n   ```\n\n#### ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆå¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼‰\n```bash\n# åœ¨æœåŠ¡å™¨ä¸Šé…ç½® Git å‡­æ®\ngit config --global user.name \"Your Name\"\ngit config --global user.email \"your-email@example.com\"\n\n# ä½¿ç”¨ Personal Access Token\ngit config --global credential.helper store\necho \"https://username:token@github.com\" > ~/.git-credentials\n```\n\n## ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨æœåŠ¡\n\n### 1. å¯åŠ¨ Webhook æœåŠ¡\n```bash\ncd /var/www/hooks\n\n# è®¾ç½®ç¯å¢ƒå˜é‡\nexport WEBHOOK_SECRET=\"your-webhook-secret\"\nexport PORT=3001\n\n# ä½¿ç”¨ PM2 å¯åŠ¨ Webhook æœåŠ¡\npm2 start webhook.js --name webhook --env production\n\n# æŸ¥çœ‹æœåŠ¡çŠ¶æ€\npm2 status\npm2 logs webhook\n```\n\n### 2. å¯åŠ¨ Next.js åº”ç”¨\n\n#### é¦–æ¬¡éƒ¨ç½²\n```bash\n# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰\ncd /var/www\ngit clone https://github.com/your-username/my-resume.git\n\n# è¿›å…¥é¡¹ç›®ç›®å½•\ncd my-resume\n\n# å®‰è£…ä¾èµ–\nnpm install --legacy-peer-deps\n\n# æ„å»ºé¡¹ç›®\nnpm run build\n\n# ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨\npm2 start npm --name my-resume -- run start\n\n# è®¾ç½®å¼€æœºè‡ªå¯\npm2 startup\npm2 save\n```\n\n#### PM2 é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰\nåˆ›å»º `ecosystem.config.js`ï¼š\n```javascript\nmodule.exports = {\n  apps: [\n    {\n      name: 'my-resume',\n      script: 'npm',\n      args: 'run start',\n      cwd: '/var/www/my-resume',\n      instances: 1,\n      autorestart: true,\n      watch: false,\n      max_memory_restart: '1G',\n      env: {\n        NODE_ENV: 'production',\n        PORT: 3000\n      },\n      error_file: '/var/www/logs/my-resume-error.log',\n      out_file: '/var/www/logs/my-resume-out.log',\n      log_file: '/var/www/logs/my-resume.log'\n    },\n    {\n      name: 'webhook',\n      script: '/var/www/hooks/webhook.js',\n      cwd: '/var/www/hooks',\n      instances: 1,\n      autorestart: true,\n      watch: false,\n      env: {\n        NODE_ENV: 'production',\n        PORT: 3001,\n        WEBHOOK_SECRET: 'your-webhook-secret'\n      },\n      error_file: '/var/www/logs/webhook-error.log',\n      out_file: '/var/www/logs/webhook-out.log',\n      log_file: '/var/www/logs/webhook.log'\n    }\n  ]\n};\n```\n\nä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼š\n```bash\n# åˆ›å»ºæ—¥å¿—ç›®å½•\nsudo mkdir -p /var/www/logs\nsudo chown $USER:$USER /var/www/logs\n\n# å¯åŠ¨æ‰€æœ‰æœåŠ¡\npm2 start ecosystem.config.js\n\n# ä¿å­˜é…ç½®\npm2 save\n```\n\n## ç¬¬å››æ­¥ï¼šNginx åå‘ä»£ç†é…ç½®ï¼ˆæ¨èï¼‰\n\n### Nginx é…ç½®æ–‡ä»¶\nåˆ›å»º `/etc/nginx/sites-available/my-resume`ï¼š\n```nginx\nserver {\n    listen 80;\n    server_name your-domain.com www.your-domain.com;\n\n    # é‡å®šå‘åˆ° HTTPS\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name your-domain.com www.your-domain.com;\n\n    # SSL è¯ä¹¦é…ç½®\n    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;\n\n    # SSL å®‰å…¨é…ç½®\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n\n    # ä¸»åº”ç”¨ä»£ç†\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n    }\n\n    # Webhook ä»£ç†\n    location /webhook {\n        proxy_pass http://localhost:3001;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        # é™åˆ¶è®¿é—®ï¼ˆå¯é€‰ï¼‰\n        # allow 140.82.112.0/20;  # GitHub IP èŒƒå›´\n        # deny all;\n    }\n\n    # é™æ€æ–‡ä»¶ç¼“å­˜\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\n        expires 1y;\n        add_header Cache-Control \"public, immutable\";\n        proxy_pass http://localhost:3000;\n    }\n}\n```\n\n### å¯ç”¨é…ç½®\n```bash\n# åˆ›å»ºè½¯é“¾æ¥\nsudo ln -s /etc/nginx/sites-available/my-resume /etc/nginx/sites-enabled/\n\n# æµ‹è¯•é…ç½®\nsudo nginx -t\n\n# é‡å¯ Nginx\nsudo systemctl restart nginx\n```\n\n## ç¬¬äº”æ­¥ï¼šç›‘æ§å’Œæ—¥å¿—\n\n### 1. æ—¥å¿—ç®¡ç†\n```bash\n# æŸ¥çœ‹åº”ç”¨æ—¥å¿—\npm2 logs my-resume\n\n# æŸ¥çœ‹ Webhook æ—¥å¿—\npm2 logs webhook\n\n# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—\ntail -f /var/www/hooks/deploy.log\n\n# æŸ¥çœ‹ Nginx æ—¥å¿—\nsudo tail -f /var/log/nginx/access.log\nsudo tail -f /var/log/nginx/error.log\n```\n\n### 2. ç›‘æ§è„šæœ¬\nåˆ›å»º `/var/www/hooks/monitor.sh`ï¼š\n```bash\n#!/bin/bash\n\n# æ£€æŸ¥æœåŠ¡çŠ¶æ€\ncheck_service() {\n    local service_name=$1\n    local port=$2\n\n    if pm2 list | grep -q \"$service_name.*online\"; then\n        echo \"âœ… $service_name è¿è¡Œæ­£å¸¸\"\n    else\n        echo \"âŒ $service_name æœªè¿è¡Œï¼Œæ­£åœ¨é‡å¯...\"\n        pm2 restart \"$service_name\"\n    fi\n\n    if netstat -tuln | grep -q \":$port \"; then\n        echo \"âœ… ç«¯å£ $port æ­£å¸¸ç›‘å¬\"\n    else\n        echo \"âŒ ç«¯å£ $port æœªç›‘å¬\"\n    fi\n}\n\necho \"=== æœåŠ¡ç›‘æ§æŠ¥å‘Š $(date) ===\"\ncheck_service \"my-resume\" 3000\ncheck_service \"webhook\" 3001\n\n# æ£€æŸ¥ç£ç›˜ç©ºé—´\ndf -h | grep -E \"(/$|/var)\" | awk '{print \"ğŸ’¾ ç£ç›˜ä½¿ç”¨: \" $5 \" (\" $1 \")\"}'\n\n# æ£€æŸ¥å†…å­˜ä½¿ç”¨\nfree -h | grep Mem | awk '{print \"ğŸ§  å†…å­˜ä½¿ç”¨: \" $3 \"/\" $2}'\n\necho \"==========================\"\n```\n\nè®¾ç½®å®šæ—¶ç›‘æ§ï¼š\n```bash\nchmod +x /var/www/hooks/monitor.sh\n\n# æ·»åŠ åˆ° crontab\ncrontab -e\n# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰\n*/5 * * * * /var/www/hooks/monitor.sh >> /var/www/logs/monitor.log 2>&1\n```\n\n## æ•…éšœæ’é™¤\n\n### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ\n\n#### 1. Webhook æœªè§¦å‘\n```bash\n# æ£€æŸ¥ Webhook æœåŠ¡çŠ¶æ€\npm2 status webhook\npm2 logs webhook\n\n# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾\nsudo ufw status\nnetstat -tuln | grep 3001\n\n# æµ‹è¯• Webhook ç«¯ç‚¹\ncurl -X POST http://localhost:3001/webhook \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"ref\":\"refs/heads/main\"}'\n```\n\n#### 2. éƒ¨ç½²è„šæœ¬å¤±è´¥\n```bash\n# æ‰‹åŠ¨æ‰§è¡Œéƒ¨ç½²è„šæœ¬\nbash /var/www/hooks/github-webhook.sh\n\n# æ£€æŸ¥æƒé™\nls -la /var/www/hooks/github-webhook.sh\nchmod +x /var/www/hooks/github-webhook.sh\n\n# æ£€æŸ¥ Git é…ç½®\ncd /var/www/my-resume\ngit status\ngit remote -v\n```\n\n#### 3. åº”ç”¨æ— æ³•å¯åŠ¨\n```bash\n# æ£€æŸ¥åº”ç”¨æ—¥å¿—\npm2 logs my-resume\n\n# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•\ncd /var/www/my-resume\nnpm run build\nnpm run start\n\n# æ£€æŸ¥ç«¯å£å ç”¨\nnetstat -tuln | grep 3000\nlsof -i :3000\n```\n\n#### 4. å†…å­˜ä¸è¶³\n```bash\n# æ£€æŸ¥å†…å­˜ä½¿ç”¨\nfree -h\npm2 monit\n\n# é‡å¯åº”ç”¨é‡Šæ”¾å†…å­˜\npm2 restart all\n\n# å¢åŠ  swap ç©ºé—´\nsudo fallocate -l 2G /swapfile\nsudo chmod 600 /swapfile\nsudo mkswap /swapfile\nsudo swapon /swapfile\n```\n\n### è°ƒè¯•æŠ€å·§\n\n#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—\n```javascript\n// åœ¨ webhook.js ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—\napp.use((req, res, next) => {\n    log(`ğŸ“¥ ${req.method} ${req.path} - ${req.ip}`);\n    next();\n});\n```\n\n#### 2. æµ‹è¯•éƒ¨ç½²æµç¨‹\n```bash\n# åˆ›å»ºæµ‹è¯•è„šæœ¬\ncat > /var/www/hooks/test-deploy.sh << 'EOF'\n#!/bin/bash\necho \"æµ‹è¯•å¼€å§‹: $(date)\"\necho \"å½“å‰ç”¨æˆ·: $(whoami)\"\necho \"å½“å‰ç›®å½•: $(pwd)\"\necho \"Git çŠ¶æ€:\"\ncd /var/www/my-resume && git status\necho \"Node ç‰ˆæœ¬: $(node --version)\"\necho \"NPM ç‰ˆæœ¬: $(npm --version)\"\necho \"PM2 çŠ¶æ€:\"\npm2 status\necho \"æµ‹è¯•ç»“æŸ: $(date)\"\nEOF\n\nchmod +x /var/www/hooks/test-deploy.sh\nbash /var/www/hooks/test-deploy.sh\n```\n\n## å®‰å…¨æœ€ä½³å®è·µ\n\n### 1. è®¿é—®æ§åˆ¶\n```bash\n# é™åˆ¶ SSH è®¿é—®\nsudo vim /etc/ssh/sshd_config\n# æ·»åŠ æˆ–ä¿®æ”¹ï¼š\n# PermitRootLogin no\n# PasswordAuthentication no\n# PubkeyAuthentication yes\n\n# é‡å¯ SSH æœåŠ¡\nsudo systemctl restart ssh\n```\n\n### 2. é˜²ç«å¢™é…ç½®\n```bash\n# åªå¼€æ”¾å¿…è¦ç«¯å£\nsudo ufw default deny incoming\nsudo ufw default allow outgoing\nsudo ufw allow 22    # SSH\nsudo ufw allow 80    # HTTP\nsudo ufw allow 443   # HTTPS\nsudo ufw enable\n```\n\n### 3. å®šæœŸå¤‡ä»½\n```bash\n# åˆ›å»ºå¤‡ä»½è„šæœ¬\ncat > /var/www/hooks/backup.sh << 'EOF'\n#!/bin/bash\nBACKUP_DIR=\"/var/backups/my-resume\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p \"$BACKUP_DIR\"\n\n# å¤‡ä»½ä»£ç \ntar -czf \"$BACKUP_DIR/code_$DATE.tar.gz\" -C /var/www my-resume\n\n# å¤‡ä»½é…ç½®\ntar -czf \"$BACKUP_DIR/config_$DATE.tar.gz\" -C /var/www hooks\n\n# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰\nfind \"$BACKUP_DIR\" -name \"*.tar.gz\" -mtime +7 -delete\n\necho \"å¤‡ä»½å®Œæˆ: $DATE\"\nEOF\n\nchmod +x /var/www/hooks/backup.sh\n\n# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰\ncrontab -e\n# æ·»åŠ ï¼š0 2 * * * /var/www/hooks/backup.sh >> /var/www/logs/backup.log 2>&1\n```\n\n### 4. ç¯å¢ƒå˜é‡ç®¡ç†\n```bash\n# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶\ncat > /var/www/hooks/.env << 'EOF'\nNODE_ENV=production\nWEBHOOK_SECRET=your-super-secret-key\nPORT=3001\nLOG_LEVEL=info\nEOF\n\n# è®¾ç½®æƒé™\nchmod 600 /var/www/hooks/.env\n\n# åœ¨ webhook.js ä¸­ä½¿ç”¨\nrequire('dotenv').config();\n```\n\n## æ€§èƒ½ä¼˜åŒ–\n\n### 1. åº”ç”¨ä¼˜åŒ–\n```javascript\n// åœ¨ next.config.js ä¸­æ·»åŠ \nmodule.exports = {\n  compress: true,\n  poweredByHeader: false,\n  generateEtags: false,\n  httpAgentOptions: {\n    keepAlive: true,\n  },\n}\n```\n\n### 2. æœåŠ¡å™¨ä¼˜åŒ–\n```bash\n# è°ƒæ•´ç³»ç»Ÿå‚æ•°\necho 'net.core.somaxconn = 65535' | sudo tee -a /etc/sysctl.conf\necho 'net.ipv4.tcp_max_syn_backlog = 65535' | sudo tee -a /etc/sysctl.conf\nsudo sysctl -p\n\n# PM2 é›†ç¾¤æ¨¡å¼\npm2 start ecosystem.config.js --env production\n```\n\n## æ€»ç»“\n\né€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œä½ å·²ç»å»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿï¼š\n\n1. âœ… **æœåŠ¡å™¨ç¯å¢ƒ** - Node.jsã€Gitã€PM2ã€Nginx\n2. âœ… **Webhook æœåŠ¡** - æ¥æ”¶ GitHub æ¨é€äº‹ä»¶\n3. âœ… **éƒ¨ç½²è„šæœ¬** - è‡ªåŠ¨æ‹‰å–ä»£ç ã€æ„å»ºã€é‡å¯\n4. âœ… **åå‘ä»£ç†** - Nginx é…ç½® SSL å’Œè´Ÿè½½å‡è¡¡\n5. âœ… **ç›‘æ§æ—¥å¿—** - å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç›‘æ§\n6. âœ… **å®‰å…¨é…ç½®** - é˜²ç«å¢™ã€è®¿é—®æ§åˆ¶ã€å¤‡ä»½\n\n### ä¸‹ä¸€æ­¥å»ºè®®\n\n- è€ƒè™‘ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²\n- é›†æˆ CI/CD å·¥å…·å¦‚ GitHub Actions\n- æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹\n- å®ç°è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°\n- é…ç½®ç›‘æ§å‘Šè­¦ç³»ç»Ÿ\n\nè¿™å¥—æ–¹æ¡ˆé€‚ç”¨äºä¸­å°å‹é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œæ‰©å±•ã€‚\n",
    "html": "<h1>GitHub Webhook å®ç°æœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²</h1>\n<h2>æ¦‚è¿°</h2>\n<p>è‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯ç°ä»£è½¯ä»¶å¼€å‘ä¸­çš„é‡è¦ç¯èŠ‚ï¼Œé€šè¿‡ GitHub Webhook å¯ä»¥å®ç°ä»£ç æ¨é€åçš„è‡ªåŠ¨éƒ¨ç½²ï¼Œå¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä»é›¶å¼€å§‹é…ç½®ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿã€‚</p>\n<h2>éƒ¨ç½²æ¶æ„</h2>\n<pre><code>GitHub Repository â†’ Webhook â†’ æœåŠ¡å™¨æ¥æ”¶ â†’ æ‰§è¡Œéƒ¨ç½²è„šæœ¬ â†’ é‡å¯åº”ç”¨\n</code></pre>\n<h2>ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨å‡†å¤‡</h2>\n<h3>1. è´­ä¹°å’Œé…ç½®æœåŠ¡å™¨</h3>\n<h4>æœåŠ¡å™¨é€‰æ‹©</h4>\n<ul>\n<li><strong>æ¨èé…ç½®</strong>: 2æ ¸4Gå†…å­˜ï¼Œ40Gç¡¬ç›˜ï¼ˆé€‚åˆä¸­å°å‹é¡¹ç›®ï¼‰</li>\n<li><strong>æ“ä½œç³»ç»Ÿ</strong>: Ubuntu 20.04 LTS æˆ– CentOS 7+</li>\n<li><strong>äº‘æœåŠ¡å•†</strong>: é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€AWSã€DigitalOcean ç­‰</li>\n</ul>\n<h4>åŸºç¡€ç¯å¢ƒå®‰è£…</h4>\n<pre><code class=\"language-bash\"># æ›´æ–°ç³»ç»Ÿ\nsudo apt update &#x26;&#x26; sudo apt upgrade -y\n\n# å®‰è£… Node.js (ä½¿ç”¨ NodeSource ä»“åº“)\ncurl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -\nsudo apt-get install -y nodejs\n\n# å®‰è£… Git\nsudo apt install git -y\n\n# å®‰è£… PM2 (è¿›ç¨‹ç®¡ç†å™¨)\nsudo npm install -g pm2\n\n# å®‰è£… Nginx (å¯é€‰ï¼Œç”¨äºåå‘ä»£ç†)\nsudo apt install nginx -y\n</code></pre>\n<h3>2. åŸŸåé…ç½®</h3>\n<h4>DNS è§£æè®¾ç½®</h4>\n<pre><code class=\"language-bash\"># A è®°å½•é…ç½®ç¤ºä¾‹\nType: A\nName: @\nValue: ä½ çš„æœåŠ¡å™¨IPåœ°å€\nTTL: 600\n\n# å­åŸŸåé…ç½® (å¯é€‰)\nType: A\nName: api\nValue: ä½ çš„æœåŠ¡å™¨IPåœ°å€\nTTL: 600\n</code></pre>\n<h4>SSL è¯ä¹¦é…ç½® (æ¨èä½¿ç”¨ Let's Encrypt)</h4>\n<pre><code class=\"language-bash\"># å®‰è£… Certbot\nsudo apt install certbot python3-certbot-nginx -y\n\n# è·å– SSL è¯ä¹¦\nsudo certbot --nginx -d yourdomain.com -d www.yourdomain.com\n</code></pre>\n<h3>3. å®‰å…¨ç»„é…ç½®</h3>\n<h4>å¼€æ”¾å¿…è¦ç«¯å£</h4>\n<pre><code class=\"language-bash\"># å¼€æ”¾ SSH (22)\nsudo ufw allow 22\n\n# å¼€æ”¾ HTTP (80) å’Œ HTTPS (443)\nsudo ufw allow 80\nsudo ufw allow 443\n\n# å¼€æ”¾ Webhook ç«¯å£ (3001)\nsudo ufw allow 3001\n\n# å¼€æ”¾åº”ç”¨ç«¯å£ (3000)\nsudo ufw allow 3000\n\n# å¯ç”¨é˜²ç«å¢™\nsudo ufw enable\n</code></pre>\n<h4>äº‘æœåŠ¡å•†å®‰å…¨ç»„è®¾ç½®</h4>\n<p>åœ¨äº‘æœåŠ¡å•†æ§åˆ¶å°ä¸­é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š</p>\n<ul>\n<li>å…¥æ–¹å‘ï¼šå¼€æ”¾ 22, 80, 443, 3000, 3001 ç«¯å£</li>\n<li>å‡ºæ–¹å‘ï¼šå…è®¸æ‰€æœ‰æµé‡</li>\n</ul>\n<h2>ç¬¬äºŒæ­¥ï¼šGitHub Webhook é…ç½®</h2>\n<h3>1. åˆ›å»ºéƒ¨ç½²è„šæœ¬</h3>\n<h4>åˆ›å»ºè„šæœ¬ç›®å½•</h4>\n<pre><code class=\"language-bash\"># åˆ›å»º hooks ç›®å½•\nsudo mkdir -p /var/www/hooks\nsudo chown $USER:$USER /var/www/hooks\n\n# åˆ›å»ºé¡¹ç›®ç›®å½•\nsudo mkdir -p /var/www/my-resume\nsudo chown $USER:$USER /var/www/my-resume\n</code></pre>\n<h4>éƒ¨ç½²è„šæœ¬ (<code>/var/www/hooks/github-webhook.sh</code>)</h4>\n<pre><code class=\"language-bash\">#!/bin/bash\n\n# è®¾ç½®é”™è¯¯æ—¶é€€å‡º\nset -e\n\n# æ—¥å¿—æ–‡ä»¶\nLOG_FILE=\"/var/www/hooks/deploy.log\"\nPROJECT_DIR=\"/var/www/my-resume\"\n\n# è®°å½•æ—¥å¿—å‡½æ•°\nlog() {\n    echo \"$(date '+%Y-%m-%d %H:%M:%S') - $1\" | tee -a \"$LOG_FILE\"\n}\n\nlog \"=== å¼€å§‹éƒ¨ç½² ===\"\n\n# æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨\nif [ ! -d \"$PROJECT_DIR\" ]; then\n    log \"é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨å…‹éš†ä»“åº“...\"\n    git clone https://github.com/your-username/my-resume.git \"$PROJECT_DIR\"\n    cd \"$PROJECT_DIR\"\nelse\n    cd \"$PROJECT_DIR\" || { log \"è¿›å…¥é¡¹ç›®ç›®å½•å¤±è´¥\"; exit 1; }\nfi\n\nlog \"æ‹‰å–æœ€æ–°ä»£ç ...\"\ngit fetch || { log \"git fetch å¤±è´¥\"; exit 1; }\ngit reset --hard origin/main || { log \"git reset å¤±è´¥\"; exit 1; }\ngit pull origin main || { log \"git pull å¤±è´¥\"; exit 1; }\n\nlog \"å®‰è£…ä¾èµ–...\"\nnpm install --legacy-peer-deps || { log \"npm install å¤±è´¥\"; exit 1; }\n\nlog \"æ„å»ºé¡¹ç›®...\"\nnpm run build || { log \"npm run build å¤±è´¥\"; exit 1; }\n\nlog \"é‡å¯ PM2 æœåŠ¡...\"\npm2 restart my-resume || {\n    log \"PM2 é‡å¯å¤±è´¥ï¼Œå°è¯•å¯åŠ¨æ–°å®ä¾‹...\"\n    pm2 start npm --name my-resume -- run start\n}\n\nlog \"æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶...\"\nfind \"$PROJECT_DIR\" -name \"node_modules\" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true\n\nlog \"=== éƒ¨ç½²å®Œæˆ ===\"\n</code></pre>\n<h4>è®¾ç½®è„šæœ¬æƒé™</h4>\n<pre><code class=\"language-bash\">chmod +x /var/www/hooks/github-webhook.sh\n</code></pre>\n<h3>2. Webhook æœåŠ¡å™¨</h3>\n<h4>åˆ›å»º Webhook æœåŠ¡ (<code>/var/www/hooks/webhook.js</code>)</h4>\n<pre><code class=\"language-javascript\">const express = require('express');\nconst crypto = require('crypto');\nconst { exec } = require('child_process');\nconst fs = require('fs');\nconst path = require('path');\n\nconst app = express();\nconst PORT = process.env.PORT || 3001;\nconst SECRET = process.env.WEBHOOK_SECRET || 'your-webhook-secret';\nconst LOG_FILE = '/var/www/hooks/webhook.log';\n\n// ä¸­é—´ä»¶\napp.use(express.json({ limit: '1mb' }));\napp.use(express.urlencoded({ extended: true }));\n\n// æ—¥å¿—å‡½æ•°\nconst log = (message) => {\n    const timestamp = new Date().toISOString();\n    const logMessage = `${timestamp} - ${message}\\n`;\n    console.log(logMessage.trim());\n    fs.appendFileSync(LOG_FILE, logMessage);\n};\n\n// éªŒè¯ GitHub Webhook ç­¾å\nconst verifySignature = (payload, signature) => {\n    if (!signature) return false;\n\n    const hmac = crypto.createHmac('sha256', SECRET);\n    const digest = 'sha256=' + hmac.update(payload).digest('hex');\n\n    return crypto.timingSafeEqual(\n        Buffer.from(signature),\n        Buffer.from(digest)\n    );\n};\n\n// Webhook ç«¯ç‚¹\napp.post('/webhook', (req, res) => {\n    const signature = req.headers['x-hub-signature-256'];\n    const payload = JSON.stringify(req.body);\n\n    // éªŒè¯ç­¾åï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰\n    if (SECRET &#x26;&#x26; !verifySignature(payload, signature)) {\n        log('âŒ ç­¾åéªŒè¯å¤±è´¥');\n        return res.status(401).send('Unauthorized');\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æ˜¯ push äº‹ä»¶åˆ° main åˆ†æ”¯\n    if (req.body.ref !== 'refs/heads/main') {\n        log(`â„¹ï¸ å¿½ç•¥é main åˆ†æ”¯çš„æ¨é€: ${req.body.ref}`);\n        return res.status(200).send('Ignored: Not main branch');\n    }\n\n    log('ğŸš€ æ”¶åˆ° GitHub Webhookï¼Œå¼€å§‹éƒ¨ç½²...');\n\n    // æ‰§è¡Œéƒ¨ç½²è„šæœ¬\n    const deployScript = '/var/www/hooks/github-webhook.sh';\n    const child = exec(`bash ${deployScript}`, {\n        cwd: '/var/www/hooks',\n        timeout: 300000 // 5åˆ†é’Ÿè¶…æ—¶\n    });\n\n    let output = '';\n\n    child.stdout.on('data', (data) => {\n        output += data;\n        log(`ğŸ“ ${data.trim()}`);\n    });\n\n    child.stderr.on('data', (data) => {\n        output += data;\n        log(`âš ï¸ ${data.trim()}`);\n    });\n\n    child.on('close', (code) => {\n        if (code === 0) {\n            log('âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ');\n            res.status(200).send('Deployment successful');\n        } else {\n            log(`âŒ éƒ¨ç½²å¤±è´¥ï¼Œé€€å‡ºç : ${code}`);\n            res.status(500).send('Deployment failed');\n        }\n    });\n\n    child.on('error', (error) => {\n        log(`âŒ æ‰§è¡Œè„šæœ¬æ—¶å‡ºé”™: ${error.message}`);\n        res.status(500).send('Script execution error');\n    });\n});\n\n// å¥åº·æ£€æŸ¥ç«¯ç‚¹\napp.get('/health', (req, res) => {\n    res.status(200).json({\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n        uptime: process.uptime()\n    });\n});\n\n// æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰\napp.get('/logs', (req, res) => {\n    try {\n        const logs = fs.readFileSync(LOG_FILE, 'utf8');\n        res.type('text/plain').send(logs);\n    } catch (error) {\n        res.status(404).send('Log file not found');\n    }\n});\n\n// é”™è¯¯å¤„ç†ä¸­é—´ä»¶\napp.use((error, req, res, next) => {\n    log(`âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}`);\n    res.status(500).send('Internal Server Error');\n});\n\n// å¯åŠ¨æœåŠ¡å™¨\napp.listen(PORT, '0.0.0.0', () => {\n    log(`ğŸŒ Webhook æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);\n});\n\n// ä¼˜é›…å…³é—­\nprocess.on('SIGTERM', () => {\n    log('ğŸ“´ æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n    process.exit(0);\n});\n\nprocess.on('SIGINT', () => {\n    log('ğŸ“´ æ”¶åˆ° SIGINT ä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');\n    process.exit(0);\n});\n</code></pre>\n<h4>å®‰è£…ä¾èµ–</h4>\n<pre><code class=\"language-bash\">cd /var/www/hooks\nnpm init -y\nnpm install express\n</code></pre>\n<h3>3. GitHub ä»“åº“é…ç½®</h3>\n<h4>åœ¨ GitHub ä¸­è®¾ç½® Webhook</h4>\n<ol>\n<li>è¿›å…¥ä½ çš„ GitHub ä»“åº“</li>\n<li>ç‚¹å‡» <code>Settings</code> â†’ <code>Webhooks</code> â†’ <code>Add webhook</code></li>\n<li>é…ç½® Webhookï¼š\n<pre><code>Payload URL: http://your-domain.com:3001/webhook\nContent type: application/json\nSecret: your-webhook-secret (ä¸æœåŠ¡å™¨ä¸­çš„ SECRET ä¸€è‡´)\nEvents: Just the push event\nActive: âœ“\n</code></pre>\n</li>\n</ol>\n<h4>ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆå¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼‰</h4>\n<pre><code class=\"language-bash\"># åœ¨æœåŠ¡å™¨ä¸Šé…ç½® Git å‡­æ®\ngit config --global user.name \"Your Name\"\ngit config --global user.email \"your-email@example.com\"\n\n# ä½¿ç”¨ Personal Access Token\ngit config --global credential.helper store\necho \"https://username:token@github.com\" > ~/.git-credentials\n</code></pre>\n<h2>ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨æœåŠ¡</h2>\n<h3>1. å¯åŠ¨ Webhook æœåŠ¡</h3>\n<pre><code class=\"language-bash\">cd /var/www/hooks\n\n# è®¾ç½®ç¯å¢ƒå˜é‡\nexport WEBHOOK_SECRET=\"your-webhook-secret\"\nexport PORT=3001\n\n# ä½¿ç”¨ PM2 å¯åŠ¨ Webhook æœåŠ¡\npm2 start webhook.js --name webhook --env production\n\n# æŸ¥çœ‹æœåŠ¡çŠ¶æ€\npm2 status\npm2 logs webhook\n</code></pre>\n<h3>2. å¯åŠ¨ Next.js åº”ç”¨</h3>\n<h4>é¦–æ¬¡éƒ¨ç½²</h4>\n<pre><code class=\"language-bash\"># å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰\ncd /var/www\ngit clone https://github.com/your-username/my-resume.git\n\n# è¿›å…¥é¡¹ç›®ç›®å½•\ncd my-resume\n\n# å®‰è£…ä¾èµ–\nnpm install --legacy-peer-deps\n\n# æ„å»ºé¡¹ç›®\nnpm run build\n\n# ä½¿ç”¨ PM2 å¯åŠ¨åº”ç”¨\npm2 start npm --name my-resume -- run start\n\n# è®¾ç½®å¼€æœºè‡ªå¯\npm2 startup\npm2 save\n</code></pre>\n<h4>PM2 é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰</h4>\n<p>åˆ›å»º <code>ecosystem.config.js</code>ï¼š</p>\n<pre><code class=\"language-javascript\">module.exports = {\n  apps: [\n    {\n      name: 'my-resume',\n      script: 'npm',\n      args: 'run start',\n      cwd: '/var/www/my-resume',\n      instances: 1,\n      autorestart: true,\n      watch: false,\n      max_memory_restart: '1G',\n      env: {\n        NODE_ENV: 'production',\n        PORT: 3000\n      },\n      error_file: '/var/www/logs/my-resume-error.log',\n      out_file: '/var/www/logs/my-resume-out.log',\n      log_file: '/var/www/logs/my-resume.log'\n    },\n    {\n      name: 'webhook',\n      script: '/var/www/hooks/webhook.js',\n      cwd: '/var/www/hooks',\n      instances: 1,\n      autorestart: true,\n      watch: false,\n      env: {\n        NODE_ENV: 'production',\n        PORT: 3001,\n        WEBHOOK_SECRET: 'your-webhook-secret'\n      },\n      error_file: '/var/www/logs/webhook-error.log',\n      out_file: '/var/www/logs/webhook-out.log',\n      log_file: '/var/www/logs/webhook.log'\n    }\n  ]\n};\n</code></pre>\n<p>ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼š</p>\n<pre><code class=\"language-bash\"># åˆ›å»ºæ—¥å¿—ç›®å½•\nsudo mkdir -p /var/www/logs\nsudo chown $USER:$USER /var/www/logs\n\n# å¯åŠ¨æ‰€æœ‰æœåŠ¡\npm2 start ecosystem.config.js\n\n# ä¿å­˜é…ç½®\npm2 save\n</code></pre>\n<h2>ç¬¬å››æ­¥ï¼šNginx åå‘ä»£ç†é…ç½®ï¼ˆæ¨èï¼‰</h2>\n<h3>Nginx é…ç½®æ–‡ä»¶</h3>\n<p>åˆ›å»º <code>/etc/nginx/sites-available/my-resume</code>ï¼š</p>\n<pre><code class=\"language-nginx\">server {\n    listen 80;\n    server_name your-domain.com www.your-domain.com;\n\n    # é‡å®šå‘åˆ° HTTPS\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name your-domain.com www.your-domain.com;\n\n    # SSL è¯ä¹¦é…ç½®\n    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;\n\n    # SSL å®‰å…¨é…ç½®\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n\n    # ä¸»åº”ç”¨ä»£ç†\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n    }\n\n    # Webhook ä»£ç†\n    location /webhook {\n        proxy_pass http://localhost:3001;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        # é™åˆ¶è®¿é—®ï¼ˆå¯é€‰ï¼‰\n        # allow 140.82.112.0/20;  # GitHub IP èŒƒå›´\n        # deny all;\n    }\n\n    # é™æ€æ–‡ä»¶ç¼“å­˜\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\n        expires 1y;\n        add_header Cache-Control \"public, immutable\";\n        proxy_pass http://localhost:3000;\n    }\n}\n</code></pre>\n<h3>å¯ç”¨é…ç½®</h3>\n<pre><code class=\"language-bash\"># åˆ›å»ºè½¯é“¾æ¥\nsudo ln -s /etc/nginx/sites-available/my-resume /etc/nginx/sites-enabled/\n\n# æµ‹è¯•é…ç½®\nsudo nginx -t\n\n# é‡å¯ Nginx\nsudo systemctl restart nginx\n</code></pre>\n<h2>ç¬¬äº”æ­¥ï¼šç›‘æ§å’Œæ—¥å¿—</h2>\n<h3>1. æ—¥å¿—ç®¡ç†</h3>\n<pre><code class=\"language-bash\"># æŸ¥çœ‹åº”ç”¨æ—¥å¿—\npm2 logs my-resume\n\n# æŸ¥çœ‹ Webhook æ—¥å¿—\npm2 logs webhook\n\n# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—\ntail -f /var/www/hooks/deploy.log\n\n# æŸ¥çœ‹ Nginx æ—¥å¿—\nsudo tail -f /var/log/nginx/access.log\nsudo tail -f /var/log/nginx/error.log\n</code></pre>\n<h3>2. ç›‘æ§è„šæœ¬</h3>\n<p>åˆ›å»º <code>/var/www/hooks/monitor.sh</code>ï¼š</p>\n<pre><code class=\"language-bash\">#!/bin/bash\n\n# æ£€æŸ¥æœåŠ¡çŠ¶æ€\ncheck_service() {\n    local service_name=$1\n    local port=$2\n\n    if pm2 list | grep -q \"$service_name.*online\"; then\n        echo \"âœ… $service_name è¿è¡Œæ­£å¸¸\"\n    else\n        echo \"âŒ $service_name æœªè¿è¡Œï¼Œæ­£åœ¨é‡å¯...\"\n        pm2 restart \"$service_name\"\n    fi\n\n    if netstat -tuln | grep -q \":$port \"; then\n        echo \"âœ… ç«¯å£ $port æ­£å¸¸ç›‘å¬\"\n    else\n        echo \"âŒ ç«¯å£ $port æœªç›‘å¬\"\n    fi\n}\n\necho \"=== æœåŠ¡ç›‘æ§æŠ¥å‘Š $(date) ===\"\ncheck_service \"my-resume\" 3000\ncheck_service \"webhook\" 3001\n\n# æ£€æŸ¥ç£ç›˜ç©ºé—´\ndf -h | grep -E \"(/$|/var)\" | awk '{print \"ğŸ’¾ ç£ç›˜ä½¿ç”¨: \" $5 \" (\" $1 \")\"}'\n\n# æ£€æŸ¥å†…å­˜ä½¿ç”¨\nfree -h | grep Mem | awk '{print \"ğŸ§  å†…å­˜ä½¿ç”¨: \" $3 \"/\" $2}'\n\necho \"==========================\"\n</code></pre>\n<p>è®¾ç½®å®šæ—¶ç›‘æ§ï¼š</p>\n<pre><code class=\"language-bash\">chmod +x /var/www/hooks/monitor.sh\n\n# æ·»åŠ åˆ° crontab\ncrontab -e\n# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰\n*/5 * * * * /var/www/hooks/monitor.sh >> /var/www/logs/monitor.log 2>&#x26;1\n</code></pre>\n<h2>æ•…éšœæ’é™¤</h2>\n<h3>å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</h3>\n<h4>1. Webhook æœªè§¦å‘</h4>\n<pre><code class=\"language-bash\"># æ£€æŸ¥ Webhook æœåŠ¡çŠ¶æ€\npm2 status webhook\npm2 logs webhook\n\n# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾\nsudo ufw status\nnetstat -tuln | grep 3001\n\n# æµ‹è¯• Webhook ç«¯ç‚¹\ncurl -X POST http://localhost:3001/webhook \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"ref\":\"refs/heads/main\"}'\n</code></pre>\n<h4>2. éƒ¨ç½²è„šæœ¬å¤±è´¥</h4>\n<pre><code class=\"language-bash\"># æ‰‹åŠ¨æ‰§è¡Œéƒ¨ç½²è„šæœ¬\nbash /var/www/hooks/github-webhook.sh\n\n# æ£€æŸ¥æƒé™\nls -la /var/www/hooks/github-webhook.sh\nchmod +x /var/www/hooks/github-webhook.sh\n\n# æ£€æŸ¥ Git é…ç½®\ncd /var/www/my-resume\ngit status\ngit remote -v\n</code></pre>\n<h4>3. åº”ç”¨æ— æ³•å¯åŠ¨</h4>\n<pre><code class=\"language-bash\"># æ£€æŸ¥åº”ç”¨æ—¥å¿—\npm2 logs my-resume\n\n# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•\ncd /var/www/my-resume\nnpm run build\nnpm run start\n\n# æ£€æŸ¥ç«¯å£å ç”¨\nnetstat -tuln | grep 3000\nlsof -i :3000\n</code></pre>\n<h4>4. å†…å­˜ä¸è¶³</h4>\n<pre><code class=\"language-bash\"># æ£€æŸ¥å†…å­˜ä½¿ç”¨\nfree -h\npm2 monit\n\n# é‡å¯åº”ç”¨é‡Šæ”¾å†…å­˜\npm2 restart all\n\n# å¢åŠ  swap ç©ºé—´\nsudo fallocate -l 2G /swapfile\nsudo chmod 600 /swapfile\nsudo mkswap /swapfile\nsudo swapon /swapfile\n</code></pre>\n<h3>è°ƒè¯•æŠ€å·§</h3>\n<h4>1. å¯ç”¨è¯¦ç»†æ—¥å¿—</h4>\n<pre><code class=\"language-javascript\">// åœ¨ webhook.js ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—\napp.use((req, res, next) => {\n    log(`ğŸ“¥ ${req.method} ${req.path} - ${req.ip}`);\n    next();\n});\n</code></pre>\n<h4>2. æµ‹è¯•éƒ¨ç½²æµç¨‹</h4>\n<pre><code class=\"language-bash\"># åˆ›å»ºæµ‹è¯•è„šæœ¬\ncat > /var/www/hooks/test-deploy.sh &#x3C;&#x3C; 'EOF'\n#!/bin/bash\necho \"æµ‹è¯•å¼€å§‹: $(date)\"\necho \"å½“å‰ç”¨æˆ·: $(whoami)\"\necho \"å½“å‰ç›®å½•: $(pwd)\"\necho \"Git çŠ¶æ€:\"\ncd /var/www/my-resume &#x26;&#x26; git status\necho \"Node ç‰ˆæœ¬: $(node --version)\"\necho \"NPM ç‰ˆæœ¬: $(npm --version)\"\necho \"PM2 çŠ¶æ€:\"\npm2 status\necho \"æµ‹è¯•ç»“æŸ: $(date)\"\nEOF\n\nchmod +x /var/www/hooks/test-deploy.sh\nbash /var/www/hooks/test-deploy.sh\n</code></pre>\n<h2>å®‰å…¨æœ€ä½³å®è·µ</h2>\n<h3>1. è®¿é—®æ§åˆ¶</h3>\n<pre><code class=\"language-bash\"># é™åˆ¶ SSH è®¿é—®\nsudo vim /etc/ssh/sshd_config\n# æ·»åŠ æˆ–ä¿®æ”¹ï¼š\n# PermitRootLogin no\n# PasswordAuthentication no\n# PubkeyAuthentication yes\n\n# é‡å¯ SSH æœåŠ¡\nsudo systemctl restart ssh\n</code></pre>\n<h3>2. é˜²ç«å¢™é…ç½®</h3>\n<pre><code class=\"language-bash\"># åªå¼€æ”¾å¿…è¦ç«¯å£\nsudo ufw default deny incoming\nsudo ufw default allow outgoing\nsudo ufw allow 22    # SSH\nsudo ufw allow 80    # HTTP\nsudo ufw allow 443   # HTTPS\nsudo ufw enable\n</code></pre>\n<h3>3. å®šæœŸå¤‡ä»½</h3>\n<pre><code class=\"language-bash\"># åˆ›å»ºå¤‡ä»½è„šæœ¬\ncat > /var/www/hooks/backup.sh &#x3C;&#x3C; 'EOF'\n#!/bin/bash\nBACKUP_DIR=\"/var/backups/my-resume\"\nDATE=$(date +%Y%m%d_%H%M%S)\n\nmkdir -p \"$BACKUP_DIR\"\n\n# å¤‡ä»½ä»£ç \ntar -czf \"$BACKUP_DIR/code_$DATE.tar.gz\" -C /var/www my-resume\n\n# å¤‡ä»½é…ç½®\ntar -czf \"$BACKUP_DIR/config_$DATE.tar.gz\" -C /var/www hooks\n\n# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰\nfind \"$BACKUP_DIR\" -name \"*.tar.gz\" -mtime +7 -delete\n\necho \"å¤‡ä»½å®Œæˆ: $DATE\"\nEOF\n\nchmod +x /var/www/hooks/backup.sh\n\n# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰\ncrontab -e\n# æ·»åŠ ï¼š0 2 * * * /var/www/hooks/backup.sh >> /var/www/logs/backup.log 2>&#x26;1\n</code></pre>\n<h3>4. ç¯å¢ƒå˜é‡ç®¡ç†</h3>\n<pre><code class=\"language-bash\"># åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶\ncat > /var/www/hooks/.env &#x3C;&#x3C; 'EOF'\nNODE_ENV=production\nWEBHOOK_SECRET=your-super-secret-key\nPORT=3001\nLOG_LEVEL=info\nEOF\n\n# è®¾ç½®æƒé™\nchmod 600 /var/www/hooks/.env\n\n# åœ¨ webhook.js ä¸­ä½¿ç”¨\nrequire('dotenv').config();\n</code></pre>\n<h2>æ€§èƒ½ä¼˜åŒ–</h2>\n<h3>1. åº”ç”¨ä¼˜åŒ–</h3>\n<pre><code class=\"language-javascript\">// åœ¨ next.config.js ä¸­æ·»åŠ \nmodule.exports = {\n  compress: true,\n  poweredByHeader: false,\n  generateEtags: false,\n  httpAgentOptions: {\n    keepAlive: true,\n  },\n}\n</code></pre>\n<h3>2. æœåŠ¡å™¨ä¼˜åŒ–</h3>\n<pre><code class=\"language-bash\"># è°ƒæ•´ç³»ç»Ÿå‚æ•°\necho 'net.core.somaxconn = 65535' | sudo tee -a /etc/sysctl.conf\necho 'net.ipv4.tcp_max_syn_backlog = 65535' | sudo tee -a /etc/sysctl.conf\nsudo sysctl -p\n\n# PM2 é›†ç¾¤æ¨¡å¼\npm2 start ecosystem.config.js --env production\n</code></pre>\n<h2>æ€»ç»“</h2>\n<p>é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œä½ å·²ç»å»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿï¼š</p>\n<ol>\n<li>âœ… <strong>æœåŠ¡å™¨ç¯å¢ƒ</strong> - Node.jsã€Gitã€PM2ã€Nginx</li>\n<li>âœ… <strong>Webhook æœåŠ¡</strong> - æ¥æ”¶ GitHub æ¨é€äº‹ä»¶</li>\n<li>âœ… <strong>éƒ¨ç½²è„šæœ¬</strong> - è‡ªåŠ¨æ‹‰å–ä»£ç ã€æ„å»ºã€é‡å¯</li>\n<li>âœ… <strong>åå‘ä»£ç†</strong> - Nginx é…ç½® SSL å’Œè´Ÿè½½å‡è¡¡</li>\n<li>âœ… <strong>ç›‘æ§æ—¥å¿—</strong> - å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç›‘æ§</li>\n<li>âœ… <strong>å®‰å…¨é…ç½®</strong> - é˜²ç«å¢™ã€è®¿é—®æ§åˆ¶ã€å¤‡ä»½</li>\n</ol>\n<h3>ä¸‹ä¸€æ­¥å»ºè®®</h3>\n<ul>\n<li>è€ƒè™‘ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²</li>\n<li>é›†æˆ CI/CD å·¥å…·å¦‚ GitHub Actions</li>\n<li>æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹</li>\n<li>å®ç°è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°</li>\n<li>é…ç½®ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</li>\n</ul>\n<p>è¿™å¥—æ–¹æ¡ˆé€‚ç”¨äºä¸­å°å‹é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œæ‰©å±•ã€‚</p>"
  },
  "_id": "articles/webhook-to-deploy.md",
  "_raw": {
    "sourceFilePath": "articles/webhook-to-deploy.md",
    "sourceFileName": "webhook-to-deploy.md",
    "sourceFileDir": "articles",
    "contentType": "markdown",
    "flattenedPath": "articles/webhook-to-deploy"
  },
  "type": "Article",
  "slug": "webhook-to-deploy",
  "readingTime": {
    "text": "15 min read",
    "minutes": 14.85,
    "time": 891000,
    "words": 2970
  },
  "url": "/articles/webhook-to-deploy"
}