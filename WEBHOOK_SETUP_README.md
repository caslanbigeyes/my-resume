# Webhook自动部署服务配置指南\n\n本项目配置了一个webhook服务，用于监控GitHub代码推送并自动重新部署项目。\n\n## 🚀 快速开始\n\n### 1. 部署Webhook服务\n\n在本地项目目录运行以下命令，将webhook服务部署到服务器：\n\n```bash\n# 给部署脚本执行权限\nchmod +x deploy-webhook.sh\n\n# 部署webhook服务\n./deploy-webhook.sh\n```\n\n### 2. 配置GitHub Webhook\n\n1. 打开你的GitHub仓库\n2. 进入 `Settings` > `Webhooks`\n3. 点击 `Add webhook`\n4. 配置如下：\n   - **Payload URL**: `http://47.116.219.238:3001/webhook`\n   - **Content type**: `application/json`\n   - **Secret**: (可选，用于验证请求安全性)\n   - **Events**: 选择 \"Just the push event\"\n   - **Active**: 勾选\n\n5. 点击 `Add webhook`\n\n### 3. 测试自动部署\n\n推送代码到main或master分支，webhook会自动触发部署。\n\n## 📋 服务端点\n\nWebhook服务运行在 `http://47.116.219.238:3001`，提供以下端点：\n\n| 端点 | 方法 | 描述 |\n|------|------|------|\n| `/webhook` | POST | GitHub webhook处理 |\n| `/deploy` | POST | 手动触发部署 |\n| `/status` | GET | 查看服务状态 |\n| `/logs` | GET | 查看部署日志 |\n| `/` | GET | 帮助信息 |\n\n## 🧪 测试命令\n\n```bash\n# 检查webhook服务状态\ncurl http://47.116.219.238:3001/status\n\n# 手动触发部署\ncurl -X POST http://47.116.219.238:3001/deploy\n\n# 查看部署日志\ncurl http://47.116.219.238:3001/logs\n\n# 查看帮助信息\ncurl http://47.116.219.238:3001/\n```\n\n## 🔧 服务管理\n\n### 查看服务状态\n```bash\n# SSH到服务器\nssh root@47.116.219.238\n\n# 查看PM2进程\npm2 list\n\n# 查看webhook服务日志\npm2 logs webhook-server\n```\n\n### 重启服务\n```bash\n# 重启webhook服务\npm2 restart webhook-server\n\n# 或者重新运行启动脚本\ncd /root/my-resume\n./start-webhook.sh\n```\n\n### 停止服务\n```bash\n# 停止webhook服务\npm2 stop webhook-server\n\n# 删除PM2进程\npm2 delete webhook-server\n```\n\n## 📝 部署流程\n\n当收到GitHub webhook时，服务会执行以下步骤：\n\n1. **验证请求** - 检查是否为main/master分支的push事件\n2. **拉取代码** - 从GitHub拉取最新代码\n3. **安装依赖** - 运行 `npm install --legacy-peer-deps`\n4. **构建项目** - 运行 `npm run build`\n5. **重启应用** - 使用PM2重启应用服务\n6. **验证部署** - 检查应用是否正常运行\n\n## 🔒 安全配置\n\n### 设置Webhook密钥（推荐）\n\n1. 在GitHub webhook配置中设置Secret\n2. 在服务器上设置环境变量：\n\n```bash\n# 编辑环境变量\necho 'export WEBHOOK_SECRET=\"your-secret-key\"' >> ~/.bashrc\nsource ~/.bashrc\n\n# 重启webhook服务\npm2 restart webhook-server\n```\n\n### 防火墙配置\n\n确保服务器防火墙允许3001端口的入站连接：\n\n```bash\n# 如果使用iptables\niptables -A INPUT -p tcp --dport 3001 -j ACCEPT\n\n# 如果使用firewalld\nfirewall-cmd --permanent --add-port=3001/tcp\nfirewall-cmd --reload\n```\n\n## 🐛 故障排除\n\n### 常见问题\n\n1. **端口被占用**\n   ```bash\n   # 查看端口占用\n   netstat -tlnp | grep 3001\n   \n   # 终止占用进程\n   lsof -ti:3001 | xargs kill -9\n   ```\n\n2. **权限问题**\n   ```bash\n   # 确保脚本有执行权限\n   chmod +x start-webhook.sh\n   chmod +x deploy-webhook.sh\n   ```\n\n3. **Node.js版本问题**\n   ```bash\n   # 检查Node.js版本\n   node --version\n   \n   # 应该是v20.x或更高版本\n   ```\n\n4. **PM2问题**\n   ```bash\n   # 重置PM2\n   pm2 kill\n   pm2 start webhook-server.js --name webhook-server\n   ```\n\n### 查看日志\n\n```bash\n# 查看webhook服务日志\npm2 logs webhook-server\n\n# 查看部署日志\ntail -f /root/webhook-deploy.log\n\n# 查看应用日志\npm2 logs my-resume-80\n```\n\n## 📁 文件说明\n\n- `webhook-server.js` - Webhook服务器主文件\n- `start-webhook.sh` - 服务启动脚本\n- `deploy-webhook.sh` - 本地部署脚本\n- `WEBHOOK_SETUP_README.md` - 本说明文档\n\n## 🎯 高级配置\n\n### 自定义部署脚本\n\n可以修改 `webhook-server.js` 中的部署脚本部分，添加自定义的部署逻辑：\n\n```javascript\n// 在executeDeployment函数中修改deployScript变量\nconst deployScript = `\n    set -e\n    cd ${PROJECT_DIR}\n    \n    # 你的自定义部署逻辑\n    echo \"开始自定义部署...\"\n    \n    # 例如：运行测试\n    npm test\n    \n    # 例如：备份当前版本\n    cp -r .next .next.backup\n    \n    # 标准部署流程...\n`;\n```\n\n### 多分支支持\n\n修改webhook处理逻辑，支持不同分支的不同部署策略：\n\n```javascript\n// 在webhook处理中添加分支判断\nif (payload.ref === 'refs/heads/main') {\n    // 生产环境部署\n    executeDeployment('github-main');\n} else if (payload.ref === 'refs/heads/develop') {\n    // 开发环境部署\n    executeDeployment('github-develop');\n}\n```\n\n## 📞 支持\n\n如果遇到问题，请检查：\n\n1. 服务器网络连接\n2. GitHub webhook配置\n3. 服务器日志文件\n4. PM2进程状态\n\n或者查看详细的错误日志来诊断问题。\n